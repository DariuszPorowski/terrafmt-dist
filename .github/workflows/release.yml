---
name: Release

on:
  workflow_dispatch:
  schedule:
    - cron: "0 14 * * 0"

permissions: {}

jobs:
  release:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    permissions:
      contents: write
      id-token: write
      attestations: write
      artifact-metadata: write
    steps:
      - name: Resolve latest upstream tag
        id: upstream
        run: |
          set -euo pipefail
          latest=$(gh release list --repo katbyte/terrafmt --limit 1 --json tagName --jq '.[0].tagName')
          if [ -z "$latest" ]; then
            echo "No releases found in upstream repo." >&2
            exit 1
          fi
          echo "tag=$latest" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check if tag already released
        id: check_tag
        run: |
          set -euo pipefail
          if gh api "repos/${GITHUB_REPOSITORY}/git/ref/tags/${TAG}" > /dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Tag $TAG already exists, skipping release."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.upstream.outputs.tag }}

      - name: Checkout release repo
        if: steps.check_tag.outputs.exists != 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Checkout upstream source
        if: steps.check_tag.outputs.exists != 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: katbyte/terrafmt
          ref: ${{ steps.upstream.outputs.tag }}
          fetch-depth: 0
          path: terrafmt
          persist-credentials: false

      # - name: Patch upstream version constant
      #   if: steps.check_tag.outputs.exists != 'true'
      #   working-directory: terrafmt
      #   run: |
      #     set -euo pipefail
      #     version="${TAG#v}"
      #     sed -i "s/^const Version = \".*\"/const Version = \"${version}\"/" lib/version/version.go
      #   env:
      #     TAG: ${{ steps.upstream.outputs.tag }}

      - name: Setup Go
        if: steps.check_tag.outputs.exists != 'true'
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: stable

      - name: Setup Syft
        if: steps.check_tag.outputs.exists != 'true'
        uses: anchore/sbom-action/download-syft@28d71544de8eaf1b958d335707167c5f783590ad # v0.22.2

      - name: Run GoReleaser
        if: steps.check_tag.outputs.exists != 'true'
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          version: "~> v2"
          args: release --clean --config "../.goreleaser.yml" --verbose
          workdir: terrafmt
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Attest Archives
        if: steps.check_tag.outputs.exists != 'true'
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: |
            terrafmt/dist/*.tar.gz
            terrafmt/dist/*.zip
